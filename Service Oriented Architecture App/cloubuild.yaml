steps:
- name: 'gcr.io/cloud-builders/mvn'
  id: 'Build All Services'
  args: ['clean', 'install', '-DskipTests']
  entrypoint: 'mvn'

- name: 'gcr.io/cloud-builders/docker'
  id: 'Build Naming Server Image'
  waitFor: ['Build All Services']
  args: ['build', '-t', '${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/naming-server:$COMMIT_SHA', '.']
  dir: 'NamingServer'

- name: 'gcr.io/cloud-builders/docker'
  id: 'Build API Gateway Image'
  waitFor: ['Build All Services']
  args: ['build', '-t', '${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/api-gateway:$COMMIT_SHA', '.']
  dir: 'ApiGateway/ApiGateway'

- name: 'gcr.io/cloud-builders/docker'
  id: 'Build Users Service Image'
  waitFor: ['Build All Services']
  args: ['build', '-t', '${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/users-service:$COMMIT_SHA', '.']
  dir: 'UsersService'

- name: 'gcr.io/cloud-builders/docker'
  id: 'Build Bank Account Image'
  waitFor: ['Build All Services']
  args: ['build', '-t', '${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/bank-account:$COMMIT_SHA', '.']
  dir: 'BankAccount'

- name: 'gcr.io/cloud-builders/docker'
  id: 'Build Crypto Wallet Image'
  waitFor: ['Build All Services']
  args: ['build', '-t', '${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/crypto-wallet:$COMMIT_SHA', '.']
  dir: 'CryptoWallet'

- name: 'gcr.io/cloud-builders/docker'
  id: 'Build Currency Exchange Image'
  waitFor: ['Build All Services']
  args: ['build', '-t', '${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/currency-exchange:$COMMIT_SHA', '.']
  dir: 'CurrencyExchange'

- name: 'gcr.io/cloud-builders/docker'
  id: 'Build Crypto Exchange Image'
  waitFor: ['Build All Services']
  args: ['build', '-t', '${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/crypto-exchange:$COMMIT_SHA', '.']
  dir: 'CryptoExchange'

- name: 'gcr.io/cloud-builders/docker'
  id: 'Build Currency Conversion Image'
  waitFor: ['Build All Services']
  args: ['build', '-t', '${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/currency-conversion:$COMMIT_SHA', '.']
  dir: 'CurrencyConversion'

- name: 'gcr.io/cloud-builders/docker'
  id: 'Build Crypto Conversion Image'
  waitFor: ['Build All Services']
  args: ['build', '-t', '${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/crypto-conversion:$COMMIT_SHA', '.']
  dir: 'CryptoConversion'

- name: 'gcr.io/cloud-builders/docker'
  id: 'Build Trade Service Image'
  waitFor: ['Build All Services']
  args: ['build', '-t', '${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/trade-service:$COMMIT_SHA', '.']
  dir: 'TradeService'

- name: 'gcr.io/cloud-builders/docker'
  id: 'Push Naming Server Image'
  waitFor: ['Build Naming Server Image']
  args: ['push', '${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/naming-server:$COMMIT_SHA']

- name: 'gcr.io/cloud-builders/docker'
  id: 'Push API Gateway Image'
  waitFor: ['Build API Gateway Image']
  args: ['push', '${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/api-gateway:$COMMIT_SHA']

- name: 'gcr.io/cloud-builders/docker'
  id: 'Push Users Service Image'
  waitFor: ['Build Users Service Image']
  args: ['push', '${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/users-service:$COMMIT_SHA']

- name: 'gcr.io/cloud-builders/docker'
  id: 'Push Bank Account Image'
  waitFor: ['Build Bank Account Image']
  args: ['push', '${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/bank-account:$COMMIT_SHA']

- name: 'gcr.io/cloud-builders/docker'
  id: 'Push Crypto Wallet Image'
  waitFor: ['Build Crypto Wallet Image']
  args: ['push', '${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/crypto-wallet:$COMMIT_SHA']

- name: 'gcr.io/cloud-builders/docker'
  id: 'Push Currency Exchange Image'
  waitFor: ['Build Currency Exchange Image']
  args: ['push', '${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/currency-exchange:$COMMIT_SHA']

- name: 'gcr.io/cloud-builders/docker'
  id: 'Push Crypto Exchange Image'
  waitFor: ['Build Crypto Exchange Image']
  args: ['push', '${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/crypto-exchange:$COMMIT_SHA']

- name: 'gcr.io/cloud-builders/docker'
  id: 'Push Currency Conversion Image'
  waitFor: ['Build Currency Conversion Image']
  args: ['push', '${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/currency-conversion:$COMMIT_SHA']

- name: 'gcr.io/cloud-builders/docker'
  id: 'Push Crypto Conversion Image'
  waitFor: ['Build Crypto Conversion Image']
  args: ['push', '${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/crypto-conversion:$COMMIT_SHA']

- name: 'gcr.io/cloud-builders/docker'
  id: 'Push Trade Service Image'
  waitFor: ['Build Trade Service Image']
  args: ['push', '${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/trade-service:$COMMIT_SHA']

- name: 'gcr.io/cloud-builders/gcloud'
  id: 'Deploy to GKE'
  waitFor:
    - 'Push Naming Server Image'
    - 'Push API Gateway Image'
    - 'Push Users Service Image'
    - 'Push Bank Account Image'
    - 'Push Crypto Wallet Image'
    - 'Push Currency Exchange Image'
    - 'Push Crypto Exchange Image'
    - 'Push Currency Conversion Image'
    - 'Push Crypto Conversion Image'
    - 'Push Trade Service Image'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    gcloud container clusters get-credentials ${_GKE_CLUSTER} --zone ${_GKE_ZONE} --project=${PROJECT_ID}
    
    cd kubernetes/
    kustomize edit set image exchange-app/naming-server=${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/naming-server:$COMMIT_SHA
    kustomize edit set image exchange-app/api-gateway=${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/api-gateway:$COMMIT_SHA
    kustomize edit set image exchange-app/users-service=${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/users-service:$COMMIT_SHA
    kustomize edit set image exchange-app/bank-account=${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/bank-account:$COMMIT_SHA
    kustomize edit set image exchange-app/crypto-wallet=${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/crypto-wallet:$COMMIT_SHA
    kustomize edit set image exchange-app/currency-exchange=${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/currency-exchange:$COMMIT_SHA
    kustomize edit set image exchange-app/crypto-exchange=${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/crypto-exchange:$COMMIT_SHA
    kustomize edit set image exchange-app/currency-conversion=${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/currency-conversion:$COMMIT_SHA
    kustomize edit set image exchange-app/crypto-conversion=${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/crypto-conversion:$COMMIT_SHA
    kustomize edit set image exchange-app/trade-service=${_AR_HOST}/${PROJECT_ID}/${_REPO_NAME}/trade-service:$COMMIT_SHA

    kubectl apply -k .

timeout: '1200s'